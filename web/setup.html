<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Git CTF Admin Panel</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, inital-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" crossorigin="anonymous">
        <link rel="stylesheet" href="/home/alex/PycharmProjects/GitCTF/web/css/softsec.css">
        <!-- <link rel="stylesheet" href="/css/softsec.css"> -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    </head>
    <body>
        <!-- Navbar ** This needs to be copied across all files** -->
        <nav class="navbar navbar-expand-md">
            <!-- Add image at start of navbar -->
            <a class="navbar-brand" href="/index.html">
                <img src="/home/alex/PycharmProjects/GitCTF/web/images/softsec.png" alt="Git CTF Logo" width="100" height="50">
                <!-- <img src="/images/softsec.png" alt="Git CTF Logo" width="100" height="50"> -->
            </a>
            <div class="collapse navbar-collapse justify-content-end">
                <!-- Div with rounded corners for button -->
                <a class="btn btn-secondary nav-link" href="/"><i class="fas fa-home"></i> Home</a>
                <a class="btn btn-secondary nav-link" href="/setup.html"><i class="fas fa-plus-circle"></i> Start New CTF</a>
                <a class="btn btn-secondary nav-link" href="/manage.html"><i class="fas fa-edit"></i> Manage Existing CTF</a>
            </div>
        </nav>

        <!-- Body -->
        <div class="container">
            <form class="row form-horizontal needs-validation" action="" id="make-ctf-form" default>
                <div class="form-group date">
                    <label class="form-label" for="startDate"><i class="fas fa-flag"></i> &nbsp; <i class="fas fa-calendar-alt"></i> Date to open repos for CTF</label>
                    <input id="startDate" class="form-control" type="date" required/>
                </div>
                <div class="form-group">
                    <label for="base-image" class="form-label"><i class="fas fa-flag"></i> &nbsp; <i class="fas fa-life-ring"></i> Base Docker Image</label>
                    <input type="text" class="form-control" id="base-image" placeholder="ubuntu:latest" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="pwd"><i class="fas fa-flag"></i> &nbsp; <i class="fas fa-users"></i> Number of Teams</label>
                    <input type="number" class="form-control" id="number-of-teams" required placeholder="4">
                </div>
                <div class="form-group">
                    <label class="form-label" for="pwd"><i class="fas fa-flag"></i> &nbsp; <i class="fas fa-cogs"></i> Port Number</label>
                    <input type="number" class="form-control" id="port-number" required placeholder="2000">
                </div>
                <div class="form-group">
                    <label class="form-label" for="pwd"><i class="fas fa-flag"></i> &nbsp; <i class="fas fa-align-justify"></i> Type of service</label>
                    <select id="service-name" class="form-control" required>
                        <option value="stand-alone" selected>stand-alone</option>
                        <option value="xinitd">xinitd</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="pwd"><i class="fas fa-cubes"></i> Required Packages</label>
                    <input type="text" class="form-control" id="packages" placeholder="sudo">
                </div>
                <div class="form-group">
                    <label class="form-label" for="pwd"><i class="fas fa-terminal"></i> Custom Mirror sh command</label>
                    <input type="text" class="form-control" id="sed-command" placeholder="sed -i 's/deb.debian.org/ftp.yourmirror.com/g' /etc/apt/sources.list">
                </div>
                <div class="form-group">
                    <div class="col-sm-offset-2 col-sm-10">
                        <button type="submit" class="btn btn-success">Submit</button>
                    </div>
                </div>
            </form>
            <div>
                <span><i class="fas fa-flag"></i> &nbsp; = Required</span>
            </div>
        </div>
    </body>

    <script>
        $('#make-ctf-form')[0].addEventListener("submit", function(event){
            event.preventDefault();
            let base_image = $("#base-image")[0].value;
            let num_of_teams = $("#number-of-teams")[0].value;
            let port = Number($("#port-number")[0].value);
            let service_name = $("#service-name")[0].value;
            let req_packages = $("#packages")[0].value;
            let sed_command = $("#sed-command")[0].value;
            if (sed_command == "") {
                sed_command = "RUN echo Using default mirrors";
            } else {
                sed_command = "RUN " + sed_command;
            }
            let jsonObject = {};
            jsonObject.scoreboard_name = "scoreboard";
            jsonObject.template_path =  "/usr/local/share/gitctf";
            jsonObject.sed_cmd = sed_command;
            jsonObject.problems = {};
            for (let i = 1; i <= num_of_teams; i++) {
                jsonObject.problems['problem' + i] = {
                    "base_image": base_image,
                    "service_exe_type": service_name,
                    "repo_name": "team" + i,
                    "description": `team${i} service repositoy`,
                    "bin_src_path": "/usr/local/share/vuln64",
                    "bin_dst_path": "/service/vuln",
                    "flag_dst_path": "/var/ctf/flag",
                    "bin_args": "",
                    "port": port,
                    "required_packages": req_packages
                };
            }
            console.log(jsonObject);
            $.post("/setup", JSON.stringify(jsonObject), function(result){
                if (confirm("Using this data, do you want to initalize the repositories?")) {
                    $.post("/create", true);
                }
            });
        }, true);
    </script>
</html>